% locked out from the system
if( any( strcmp( who, 'tTCPConnection' ) ) )
	%
	fclose( tTCPConnection.tTcpIpClient );
	%
end;%

close all;
clear all;
clear classes;
clc;
 
% import the necessary classes
import Controller.*;
import MatlabToTikZ.*;
import InternetConnection.*;
import Scenarios.*;

%
% load the parameters	
tControllerParameters			= Controller.LoadPIControllerParameters();  
tTCPConnectionParameters		= InternetConnection.LoadDefaultTCPConnectionParameters();
%
% allocate the TCP connection and the controller
tTCPConnection					= InternetConnection.KTHConnection( tTCPConnectionParameters );
tPIController					= Controller.PIController( tControllerParameters );
%
bUseTimer = true;
%
%
if ~bUseTimer
	%
	tPIController.OnStart();
	tPIController.Run( tTCPConnection , tControllerParameters );
	tPIController.OnExitNoTCPClose();
	%
else%
	%
	tControllerDebugTimer = timer(																						...
		'TimerFcn',			{@Controller.Run,				tPIController, tTCPConnection, tControllerParameters},		...
		'ErrorFcn',			{@Controller.OnError,			tPIController},												...
		'StartFcn',			{@Controller.OnStart,			tPIController},												...
		'StopFcn',			{@Controller.OnExitNoTCPClose,	tPIController},												...
		'Period',			tPIController.fSamplingTimeInSeconds,														...
		'TasksToExecute',	tPIController.iNumberOfRunsToBeExecuted,													...
		'ExecutionMode',	'fixedRate',																				...
		'BusyMode',			'drop'														);
	% 
	start( tControllerDebugTimer );
	disp('ControlTimer Started');
	%
	%Experiment is done -> We close the connection
	%
end %
%
%
% fclose( tTCPConnection.tTcpIpClient );
% %
% %always delete timers before exiting!
% %
% delete(tControllerDebugTimer);

