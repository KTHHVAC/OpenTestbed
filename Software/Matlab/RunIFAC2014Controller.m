close all;
clear all;
clear classes;
clc;
 
% to get the updated models
addpath(genpath('Models/'));

% to get CPLEX path
% addpath(genpath('/Users/giorgiopattarello/Applications/IBM/ILOG/CPLEX_Studio1251/cplex/')) %????????
addpath(genpath('C:/Program Files/IBM/ILOG/CPLEX_Studio125/cplex'));

% import the necessary classes
import EstimationAlgorithms.*;
import Controller.*;
import MatlabToTikZ.*;
import InternetConnection.*;
import Scenarios.*;

% allocate the TCP connection object
tTCPConnectionParameters			= InternetConnection.LoadDefaultTCPConnectionParameters();
tTCPConnection						= InternetConnection.KTHConnection( tTCPConnectionParameters );

% do the first allocation of the controllers
[	tCO2Controller,						...
	tTemperatureController,				...
	tPIController			] =			...
		AllocateIFAC2014Controller();

% allocate the timer for the low level control loop
tPIControlLoopTimer = timer(																	...
	'TimerFcn',			{@Controller.RunPI,				  tPIController, tTCPConnection },		...
	'ErrorFcn',			{@Controller.OnError,			{ tPIController } },					...
	'StartFcn',			{@Controller.OnStart,			{ tPIController } },					...
	'StopFcn',			{@Controller.OnExitNoTCPClose,	{ tPIController } },					...
	'Period',			tPIController.fSamplingTimeInSeconds,									...
	'TasksToExecute',	tPIController.iNumberOfRunsToBeExecuted,								...
	'ExecutionMode',	'fixedRate',															...
	'BusyMode',			'drop'																	);
%
% allocate the timer for the main control loop
tMainControlLoopTimer = timer(																										...
	'TimerFcn',			{@Controller.Run,				  tCO2Controller, tTemperatureController , tPIController, tTCPConnection },	...
	'ErrorFcn',			{@Controller.OnError,			{ tCO2Controller, tTemperatureController } },								...
	'StartFcn',			{@Controller.OnStart,			{ tCO2Controller, tTemperatureController } },								...
	'StopFcn',			{@Controller.OnExitNoTCPClose,	{ tCO2Controller, tTemperatureController } },								...
	'Period',			tCO2Controller.fSamplingTimeInSeconds,																		...
	'TasksToExecute',	tCO2Controller.iNumberOfRunsToBeExecuted,																	...
	'ExecutionMode',	'fixedRate',																								...
	'BusyMode',			'drop'														);
%
disp('Started the low level control loop');
start( tPIControlLoopTimer );
disp('Started the main control loop');
start( tMainControlLoopTimer );

% fare altro timer che alla mezzanotte fa il on exit dei 3 controllori e poi richiama
% AllocateIFAC2014Controller che li rialloca diversi
% http://www.mathworks.se/help/matlab/ref/timer.startat.html

% delete(tPIControlLoopTimer);delete(tMainControlLoopTimer);
