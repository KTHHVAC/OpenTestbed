% ASSUMPTIONS:
% - THE OCCUPANCY IS THE FIRST INPUT
% - THE SIGNALS ARE COLUMN WISE (each column is a signal)
%
function afEstimatedOccupancy =		...
			EstimateBatch(			...
				tEstimator,			...
				aafInputs,			...
				afOutput,			...
				fLambda				)% this input is not necessary. If omitted it will be set to the best lambda of the estimator
	%
	global bPrintDebugInformation;
	global tFileID;
	%
	if( nargin == 3 )
		%
		fLambda = tEstimator.fLambda;
		%
	end;%
	%
	% compute the parameters
	iNumberOfSamples	= numel(afOutput);
	iNumberOfInputs		= size(aafInputs, 2);
	[ aafA, aafB ]		= tEstimator.GetToeplitzMatrices( iNumberOfSamples );
	aafDelta			= tEstimator.GetDeltaMatrix( iNumberOfSamples );
	%
	% cost corresponding to the known part:
	% - autoregressive part
	fCostOfKnownPart = - aafA * afOutput;
	%
	% - inputs part: note that 1 is excluded because we assume the 1st
	%   component to be the occupancy
	for iInput = 2:iNumberOfInputs
		%
		fCostOfKnownPart =							...
				fCostOfKnownPart					...
			+	aafB(:,:,iInput) * aafInputs(:,iInput);
		%
	end;%
	%
	% ---------------------------------------------------------------------
	if( bPrintDebugInformation )
		%
		fprintf(tFileID, 'Starting solving a L1 problem...');
		%
	end;%
	cvx_begin quiet
		%
		variable afEstimate(iNumberOfSamples, 1)
		%
		cost = norm(	afOutput - (fCostOfKnownPart + aafB(:,:,1) * afEstimate),	... | evidence
						2														)	... |
				+																	...
				fLambda * norm(aafDelta * afEstimate, 1);							%   | regularization
		%
		minimize cost
		%
		subject to
% 			afEstimate(1)	== aafInputs(1,1);
			afEstimate(end) == afEstimate(end-1);
			afEstimate		>= 0;
		%
	cvx_end
	if( bPrintDebugInformation )
		%
		fprintf(tFileID, 'done\n');
		%
	end;%
	% ---------------------------------------------------------------------
	%
	afEstimatedOccupancy = afEstimate;
	%
end % function

