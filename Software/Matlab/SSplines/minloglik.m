

function [obj,C,Ey]=minloglik(iper,A,y,P1,P2,P3,P4,P5,R,LP,BL,cn,o2)

alfa=0;
n=size(A,1);%number of measurements to use
p=size(A,2);%number of predictor coefficients to estimate
m=size(A,3);%number of predictor impulse responses to estimate
%cn = bias space dimension


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%% HYPERPARAMETERS, b2 e b3 polynomials and the bias space %%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%[Lamb  beta  BiasN  BiasP  o2]
%[P1     P2     P3     P4   P5]
l=exp(iper(1:P1));%variances of the predictor impulse responses
b1=iper(P1+1:P1+P2);%the beta
if P3==0;
    b2=[];
else
    nBSn=P3/cn;%number of bias spaces to consider
    for j=1:nBSn
        b2(j,:)=iper((P1+P2+1+cn*(j-1)):(P1+P2+cn*j));%polynomial with poles with negative real part
    end
end
if P4==0;
    b3=[];
else
    nBSp=P4/cn;%# of bias spaces to consider
    for j=1:nBSp
        b3(j,:)=iper((P1+P2+P3+1+cn*(j-1)):(P1+P2+P3+cn*j));
    end
end
%o2=exp(iper(P1+P2+P3+P4+P5));%innovation variance
if LP==1
    Lap=exp(iper(P1+P2+P3+P4+P5));%variance (exponential density)
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%% FEASIBILITY OF THE BIAS SPACE %%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
fl=1;
if b1<0 | b1>=1;%stability of the time transformation
    fl=0;
end
if P3>0;
    for j=1:nBSn;
        q=roots([1 b2(j,:)]);
        for i=1:max(size(q));
            c(i)=norm(q(i));
            cr(i)=real(q(i));
            if c(i)>1 | c(i)<R | real(cr(i))>0;%poles with negative real part
                fl=0;
            end
        end
    end
end
if P4>0;
    for j=1:nBSp;
        q=roots([1 b3(j,:)]);
        for i=1:max(size(q));
            c(i)=norm(q(i));
            cr(i)=real(q(i));
            if c(i)>1 | c(i)<R | real(cr(i))<0;%poles with positive real part
                fl=0;
            end
        end
    end
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%MARGINAL LIKELIHOOD EVALUATION%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
if  fl==0;%no feasibility of the bias space
    obj=+inf;
else 
    if isempty(BL) | max(size(y))<BL;
        Nb=1;
        [C,Ey]=Eybuild(p,alfa,b1,b2,b3,l,A,o2,BL,Nb);
        [obj,l1,l2]=symm_invdet(Ey,y);
    else
        obj=0;
        Nb=ceil(max(size(y))/BL);
        [C,Ey,Ey2]=Eybuild(p,alfa,b1,b2,b3,l,A,o2,BL,Nb);
        for kk=1:Nb;
            if kk<Nb;
                I=[(1+(kk-1)*BL):(kk*BL)];
                [ob,l1,l2]=symm_invdet(Ey(:,:,kk),y(I));
                obj=obj+ob;
            else
                I=[(1+(kk-1)*BL):max(size(y))];
                [ob,l1,l2]=symm_invdet(Ey2,y(I));
                obj=obj+ob;
            end
        end
    end
end
if LP==1;%PENALTY FOR SPARSITY
    l=l.^0.5;
    sl=sum(abs(l));
    %R=Lap*eye(m);
    SDl=sqrt(Lap);%SD (exponential density)
    obj=obj+m*log((SDl))+(sl/SDl);%2*log(det(sqrt(2)*R))+2*sqrt(2)*(sl/sqrt(Lap));
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%obj


