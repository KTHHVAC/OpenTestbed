
%gen=1 or 2
%Pbound=0.95
%morder=30
%nf=100
%n=300
%inp=1

function [y,U,f1,yy,UU,ba,SNR,md,Utest,ytest,UtestWN,ytestWN]=creadata(morder,SNR,gen,Pbound,n,nf,inp,CI,Addzeros)


if CI==0
    zz=zeros(nf,1);
    burnin=0;
else
    zz=[];
    burnin=300;
end
if Addzeros==1;%even if CI=1 nf zeros are added to build yy and UU
   zz=zeros(nf,1);
end
   
nn=n+burnin;
N=3000;%size of test set
Utest=[];

if inp(1)==1
    ba=1;
    U=randn(1,nn);
elseif inp(1)==2 & length(inp)==3
    ba=inp(2)+(inp(3)-inp(2))*rand;
    U=idinput(nn,'rgs',[0 ba])'+0.5*idinput(nn,'rgs',[ba 1])';%%%%
elseif inp(1)==3;
    Order=inp(2);%ceil(30*inp(2));%2;%*rand;%ceil(3*rand);
    fl=0;
    while fl==0;
        m=rss(Order);
        r=eig(m.a);
        bw=bandwidth(m);
        f=bw*3*2*pi;
        try
            if f<inf & max(real(r))<0
                md=c2d(m,1/f,'zoh');
                %md.d=0;%%%%%%%%%%%%%%%? strettamente propria%%%%
                r=eig(md.a);
                if max(abs(r))<Pbound
                    f1=impulse(md,2*nf*md.Ts)';%%%%%%%%%%%%%%%%%%%%%%%%
                    if length(f1)<nf;
                        f1=[f1 zeros(1,nf-length(f1))];
                    end
                    fl=1;
                    %close all
                    %figure
                    %plot(f1)
                end
            end
        catch
            fl=0;
        end
    end;
    close all;%figure;%bode(md);pause(1);%plot(f1);pause(1)
    U=randn(1,nn);U=filter(f1,1,U);
    Utest=randn(1,N);Utest=filter(f1,1,Utest);
    ba=[2];
elseif inp(1)==4;
    U=idinput(nn,'sine')';
    Utest=idinput(N,'sine')';
    ba=[2];
elseif inp(1)==5;
    U=ones(1,nn);
    Utest=U;
    ba=[2];
end

if length(SNR)==2
    SNR=SNR(1)+(SNR(2)-SNR(1))*rand;
end

fl=0;
if gen==1;
    while fl==0;
        m=rss(morder);
        r=eig(m.a);
        bw=bandwidth(m);
        f=bw*3*2*pi;
        try
            if f<inf & max(real(r))<0
                md=c2d(m,1/f,'zoh');
                md.d=0;
                r=eig(md.a);
                if max(abs(r))<Pbound
                    f1=impulse(md,2*nf*md.Ts)';%%%%%%%%%%%%%%%%%%%%%%%%
                    if length(f1)<nf;
                        f1=[f1 zeros(1,nf-length(f1))];
                    end
                    fl=1;
                    %close all
                    %%figure
                    %plot(f1)
                end
            end
        catch
            fl=0;
        end
    end
elseif gen==2;
    while fl==0;
        [num,den]=drmodel(morder);
        r=abs(roots(den));
        if max(abs(r))<Pbound & num(1)==0;
            q=find(num>0);
            num=[0 num(q:end) zeros(1,length(den)-length([0 num(q:end)]))];
            f1=dimpulse(num,den)';
            if length(f1)<nf;
                f1=[f1 zeros(1,nf-length(f1))];
            end
            fl=1;md=[];
            %close all
            %%figure
            %plot(f1)
        end
    end
elseif gen==3;
    while fl==0;
        md=drss(morder);
        md.d=0;
        r=eig(md.a);
        if max(abs(r))<Pbound
            f1=impulse(md)';%%%%%%%%%%%%%%%%%%%%%%%%
            if length(f1)<nf;
                f1=[f1 zeros(1,nf-length(f1))];
            end
            fl=1;
        else
            fl=0;
        end
    end
elseif gen==4;%Runge
    tt=[inf 1:(nf-1)];
    mu=5+ceil(20*rand);%15*rand;%or just 15
    f1=1./[1+25*(((tt-mu)/mu).^2)];md=[];
elseif gen==5;%Runge with ^aa in place of ^2
    tt=[inf 1:(nf-1)];
    aa=1+9*rand;
    mu=5+ceil(20*rand);%15*rand;%or just 15
    f1=1./[1+25*((abs(tt-mu)/mu).^aa)];md=[];
%elseif gen==6;
%     syms s
%     x0=1;L=x0;a=0.01;%x0=rand;L=rand;a=2;
%     k=1;f=[[(-1)^(k+1)]*[2*pi*k]*sin(k*pi*x0/L)]/[(L^2)*s+(k*pi*a)^2];
%     for k=2:40;f=f+[[(-1)^(k+1)]*[2*pi*k]*sin(k*pi*x0/L)]/[(L^2)*s+(k*pi*a)^2];end
%     F=ilaplace(f);
%     f1=[0 subs(F,[1:(nf-1)])];md=[];
end

f1=f1';%/norm(f1);
z=filter(f1,1,U);
o2=var(z)/SNR;
y=z+sqrt(o2)*randn(1,length(z));
z=z((burnin+1):nn);
y=y((burnin+1):nn);
U=U((burnin+1):nn);
yy=[zz' y]';UU=[zz' U]';y=y';U=U';
ytest=filter(f1,1,Utest);
UtestWN=randn(size(Utest));
ytestWN=filter(f1,1,UtestWN);

