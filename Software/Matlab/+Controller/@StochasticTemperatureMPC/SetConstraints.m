% function SetConstraints( tController )
%
function SetConstraints( tController )
	% 
	%
 	try %
		%
		% Retreiving the needed data
		fCurrentJulianDate			=	Time.GetCurrentJulianDate();
		fSamplingTimeInJulianDates	=	Time.GetJulianSecond() * tController.fSamplingTimeInSeconds;
		iNumberOfOutputs			=	size( tController.tModel.aafC, 1 );
		iNumberOfInputs				=	size( tController.tModel.aafB, 2 );
		%------------------------------------------------------------------
		% Retriving the needed indexes
		%
		iTemperatureOfTheAirInletIndex	=	tController.tMeasurementsSignalsIndexes.iTemperatureOfFreshAirInlet;
		fTemperatureOfTheAirInlet		=	tController.atMeasurementsSignals(iTemperatureOfTheAirInletIndex).ExtractSamplesAt(fCurrentJulianDate);
		%
		% Getting the temperature of the room
		%
		iTemperatureOfTheRoomIndex		=	tController.tMeasurementsSignalsIndexes.iRoomTemperature;
		fTemperatureOfTheRoom			=	tController.atMeasurementsSignals(iTemperatureOfTheRoomIndex).ExtractSamplesAt(fCurrentJulianDate);
		%
		%------------------------------------------------------------------
		%
		fCurrentMinCoolingTemperature = 0.32 * 16.5 + 0.68 * fTemperatureOfTheAirInlet;
		fCurrentMaxHeatingTemperature = fTemperatureOfTheAirInlet;
		%
		% Initializing the vectors for the upper and lower bounds for Tsa
		%
		tController.tInputsBounds.fMinCoolingTemperature = zeros(tController.iPredictionHorizon, 1); 
		tController.tInputsBounds.fMaxHeatingTemperature = zeros(tController.iPredictionHorizon, 1);	
		%
		%
		% Setting the values of TsaMin and TsaMax depending on the current
		% temperature of the air in the duct. Furthermore, the upper and
		% lower bound over the whole prediction horizon are set in order to
		% avoid problems in the cooling and heating process. For the first
		% step we use the current value of the air; for the other steps we
		% use two fixed values.
		% -----------------------------------------------------------------
		% Cooling
		%
		if fCurrentMinCoolingTemperature > fTemperatureOfTheRoom
			%
			%
			tController.tInputsBounds.fMinCoolingTemperature(1:end) = fTemperatureOfTheRoom - 0.5;
			%
		else
			%
			tController.tInputsBounds.fMinCoolingTemperature(1:end) = fCurrentMinCoolingTemperature;
			%
		end;%
		
% 		if fCurrentMinCoolingTemperature > 18.8
% 			%
% 			%
% 			tController.tInputsBounds.fMinCoolingTemperature(2:end) = 18.8;
% 			%
% 		else
% 			%
% 			tController.tInputsBounds.fMinCoolingTemperature(2:end) = fCurrentMinCoolingTemperature;
% 			%
% 		end;%
		% -----------------------------------------------------------------	
		% Heating
		%
		if fCurrentMaxHeatingTemperature < fTemperatureOfTheRoom
			%
			%
			tController.tInputsBounds.fMaxHeatingTemperature(1:end) = fTemperatureOfTheRoom + 0.5;
			%
		else
			%
			tController.tInputsBounds.fMaxHeatingTemperature(1:end) = fCurrentMaxHeatingTemperature;
			%
		end;%
		
% 		if fCurrentMaxHeatingTemperature < 22
% 			%
% 			%
% 			tController.tInputsBounds.fMaxHeatingTemperature(2:end) = 22;
% 			%
% 		else
% 			%
% 			tController.tInputsBounds.fMaxHeatingTemperature(2:end) = fCurrentMaxHeatingTemperature;
% 			%
% 		end;%
		%
		% -----------------------------------------------------------------	
		%
		tController.tInputsBounds.afInputsLowerBounds = ...
			[																...	
			tController.tInputsBounds.DeltaTh.fLowerBound ;					...
			tController.tInputsBounds.DeltaTc.fLowerBound ;					...
			tController.tInputsBounds.AdditionalHeating.fLowerBound ;		...
			tController.tInputsBounds.AdditionalCooling.fLowerBound ;		...
			tController.tInputsBounds.DeltaTrad.fLowerBound ;				...
			];
		%
		tController.tInputsBounds.afInputsUpperBounds =						...
			[																...	
			tController.tInputsBounds.DeltaTh.fUpperBound ;					...
			tController.tInputsBounds.DeltaTc.fUpperBound ;					...
			tController.tInputsBounds.AdditionalHeating.fUpperBound ;		...
			tController.tInputsBounds.AdditionalCooling.fUpperBound ;		...
			tController.tInputsBounds.DeltaTrad.fUpperBound ;				...
			];
		%
		% -----------------------------------------------------------------
		% -----------------------------------------------------------------
		% Initializing constraints vectors and matrices
		%
		aafGuMixed	=	[	 1	 0	0	0	0	;			...
							 0	 1	0	0	0				...
						];  
		%
		afBu		= vertcat( -	tController.tInputsBounds.afInputsLowerBounds ,		...
									tController.tInputsBounds.afInputsUpperBounds		...
						 );
		afBu		= [afBu; zeros(2,1)];
		%
		tController.tModel.aaafBy		= zeros(	2 * iNumberOfOutputs, 1,			...
													tController.iPredictionHorizon);
		%
		tController.tModel.aaafLe		= zeros(	iNumberOfInputs ,					...
													iNumberOfInputs ,					...
													tController.iPredictionHorizon);
		%
		tController.tModel.aaafBMixed	= zeros(	2 *	iNumberOfOutputs , 1,			...
													tController.iPredictionHorizon);
		%
		% 
		% -----------------------------------------------------------------
		% -----------------------------------------------------------------
		% Setting constraints vectors and matrices
		%
		%
		iInitialHour	= 7; 
		iMiddleHour		= 18;
		iFinalHour		= 19;	
		%
		for iStepTime = 1: tController.iPredictionHorizon
			%
			%
			if ( Time.IsBetweenHours( fCurrentJulianDate, iInitialHour, iMiddleHour)) 
				%
				tController.tModel.aaafBy(:,:, iStepTime) =		[ -		tController.tOutputsBounds.Temperature.fLowerBoundDay;		...
																		tController.tOutputsBounds.Temperature.fUpperBoundDay		...
																 ];
				%
			elseif ( Time.IsBetweenHours( fCurrentJulianDate, iMiddleHour, iFinalHour))
				tController.tModel.aaafBy(:,:, iStepTime) =		[ -		tController.tOutputsBounds.Temperature.fLowerBoundMiddle,	...
																		tController.tOutputsBounds.Temperature.fUpperBoundMiddle	...
																 ];
				%
			else
				tController.tModel.aaafBy(:,:, iStepTime) =		[ -		tController.tOutputsBounds.Temperature.fLowerBoundNight,	...
																		tController.tOutputsBounds.Temperature.fUpperBoundNight		...
																 ];
				%
			end;%end if
			%
			fCurrentJulianDate = fCurrentJulianDate + fSamplingTimeInJulianDates;
			%
		end;%end for
		%
		fCurrentJulianDate	= Time.GetCurrentJulianDate();
		% 
		%
		iInitialHour	= 7; %%% TO DO: move it in the parameters
		iFinalHour		= 18;	
		%
		%
		for iStepTime = 1: tController.iPredictionHorizon
			%
			%
			if ( Time.IsBetweenHours( fCurrentJulianDate, iInitialHour, iFinalHour)) 
				%
				tController.tModel.aaafLe(:, :, iStepTime)			=	zeros(iNumberOfInputs);
				tController.tModel.aaafBMixed (:, :, iStepTime)		=	[		tController.tInputsBounds.fMaxHeatingTemperature(iStepTime);		...
																			-	tController.tInputsBounds.fMinCoolingTemperature(iStepTime)	];  
				%
			else
				tController.tModel.aaafLe(:,:, iStepTime)		=	diag([1,1,1,1,0],0);
				tController.tModel.aaafBMixed (:, :, iStepTime)	=	[	1000;				...
                                                                            0	];  
				%
			end;%end if
			%
			fCurrentJulianDate			=	fCurrentJulianDate + fSamplingTimeInJulianDates;
			%
		end;%end for
		%
		% Setting the right term of equality constraints
		tController.tModel.afRe	= zeros	(		iNumberOfInputs						...
											*	tController.iPredictionHorizon, 1);	
		%
		% Setting Linear constraints on inputs
		%
		for iStepTime = 1 : tController.iPredictionHorizon
			%
			fDeltaAirMass = tController.tInputsBounds.AirMassFlow.fUpperBound	-	tController.afLowerBoundForTheVentilation(iStepTime);
			%
			aafSum =				[	-fDeltaAirMass		0				 1	 	 0		0;	...
												0		-fDeltaAirMass		 0		 1		0;	...
									];
			%						
			tController.tModel.aaafGu(:,:,iStepTime) =	[	-	eye( size(tController.tModel.aafB,2 ) )	;	...
																eye( size(tController.tModel.aafB,2 ) )	;	...
																aafSum										...

														];
			%
		end;%end for
		%
		%
		% Setting of output constraints
		tController.tModel.aaafBu		= repmat( afBu,			[1, 1, tController.iPredictionHorizon]	);
		tController.tModel.aaafGy		= repmat( [-1 ; 1 ],	[1, 1, tController.iPredictionHorizon]	);
		% Adding soft constraints
		tController.tModel.aaafGe		= repmat( [ 1 ; 1 ],	[1, 1, tController.iPredictionHorizon]	);
		% Setting of mixed constraints
		tController.tModel.aaafGeMixed	= repmat( [ 1 ; 1 ],	[1, 1, tController.iPredictionHorizon]	); 
		tController.tModel.aaafGuMixed	= repmat( aafGuMixed,	[1, 1, tController.iPredictionHorizon]	);
		tController.tModel.aaafGxMixed	= repmat([	-tController.tModel.aafC;											...
													 tController.tModel.aafC ],[1, 1, tController.iPredictionHorizon]);
		%
		%
	catch exception
		%
		disp(exception.message);
		warning('Problems setting the constraints.')
		%
	end;% end catch
	%
end %



