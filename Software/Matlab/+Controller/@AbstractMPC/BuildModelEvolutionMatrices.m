% Prepare model matrices over the prediction orizon for deterministic MPC.
%
% function	[													...	
% 			aafExtendedToOrizonFreeEvolutionMatrix,				...
% 			aafExtendedToOrizonForcingEvolutionMatrix,			...					
% 			aafExtendedToOrizonDisturbanceMatrix ,				...
% 			aafExtendedToOrizonOutputMatrix						...
% 			]													...
% 			= BuildModelEvolutionMatrices(						...
% 						aafStatesTransitionMatrix,				...
% 						aafInputsToStatesMatrix,				...
% 						aafDisturbancesToStatesMatrix,			...
% 						afStatesToOutputsMatrix,				...
% 						iPredictionHorizon)
% 	
%
%
function	[													...	
			aafExtendedToOrizonFreeEvolutionMatrix,				...
			aafExtendedToOrizonForcingEvolutionMatrix,			...					
			aafExtendedToOrizonDisturbanceMatrix ,				...
			aafExtendedToOrizonOutputMatrix						...
			]													...
			= BuildModelEvolutionMatrices(						...
							aafStatesTransitionMatrix,				...
							aafInputsToStatesMatrix,				...
							aafDisturbancesToStatesMatrix,			...
							afStatesToOutputsMatrix,				...
							iPredictionHorizon	)
	%
	%
	try
		% getting the size of model's matricies
		%
		%[ iStatesMatrixSize                                     ]      = size(aafStatesTransitionMatrix);		%size of States' Matrix
		[ iStatesMatrixSize      ,	 iInputMatrixColumnSize	 ]			= size(aafInputsToStatesMatrix);		% number of states and input	
		[ iDisturbanceMatrixRowSize, iDisturbanceMatrixColumnSize]      = size(aafDisturbancesToStatesMatrix);	%size of Disturbance's Matrix
		%[ iOutputMatrixRowSize     , iOutputMatrixColumnSize    ]      = size(afOutputMatrix);					%size of Output's Matrix
		%
		%
		%
		% space allocation for matrices
		aafExtendedToOrizonFreeEvolutionMatrix      = zeros(iStatesMatrixSize * iPredictionHorizon,			iStatesMatrixSize );
		aafExtendedToOrizonForcingEvolutionMatrix   = zeros(iStatesMatrixSize * iPredictionHorizon,			iInputMatrixColumnSize * iPredictionHorizon);
		aafExtendedToOrizonDisturbanceMatrix        = zeros(iDisturbanceMatrixRowSize * iPredictionHorizon,	iDisturbanceMatrixColumnSize * iPredictionHorizon);
		%aafExtendedToOrizonOutputMatrix            = zeros(iOutputMatrixRowSize*N,			iOutputMatrixColumnSize*N );
		%
		%------------------------------------------------------------------
		% AA costruction
		%
		for iTimeStep=1:1:iPredictionHorizon
			%
			aafExtendedToOrizonFreeEvolutionMatrix((iTimeStep-1) * iStatesMatrixSize+1:iTimeStep * iStatesMatrixSize, :)                        ...
			=  aafStatesTransitionMatrix^iTimeStep;
			%
		end;%end of for
		%
		%------------------------------------------------------------------
		% CC construction
		%
		aafExtendedToOrizonOutputMatrix = kron(eye(iPredictionHorizon), afStatesToOutputsMatrix);
		%
		%------------------------------------------------------------------
		% AB construction
		%
		for iStepTimeRow=1:iPredictionHorizon
			%
			for iStepTimeColumn=1:iStepTimeRow
				%
				aafExtendedToOrizonForcingEvolutionMatrix														...
					(																							...
							(																					...
									(iStepTimeRow-1)															...
								*	iStatesMatrixSize + 1 : iStepTimeRow * iStatesMatrixSize					...
							),																					...
							(																					...
									(iStepTimeColumn-1)															...
								*	iInputMatrixColumnSize + 1 : iStepTimeColumn * iInputMatrixColumnSize	...
							)																					...
					)																							...
					=																							...
						( aafStatesTransitionMatrix^(iStepTimeRow - iStepTimeColumn) ) * aafInputsToStatesMatrix;
				%
			end;%end of innested for
			%
		end;%end of for     
		%
		%------------------------------------------------------------------
		% AE construction
		%
		for  iStepTimeRow=1:iPredictionHorizon
		   %
		   for iStepTimeColumn=1:iStepTimeRow
			   %
				aafExtendedToOrizonDisturbanceMatrix																...
					(																								...
								(iStepTimeRow-1)																	...
							*	iDisturbanceMatrixRowSize + 1 : iStepTimeRow * iDisturbanceMatrixRowSize			...
						,																							...                  			
						(																							...
								(iStepTimeColumn-1)																	...
							*	iDisturbanceMatrixColumnSize + 1 : iStepTimeColumn * iDisturbanceMatrixColumnSize	...
						)																							...		
					)																								...			
				= aafStatesTransitionMatrix^(iStepTimeRow-iStepTimeColumn)*aafDisturbancesToStatesMatrix;		
			end %end of innested for
			%
		end;%end of for  
		%
		%------------------------------------------------------------------
		%------------------------------------------------------------------
		%
	catch exception
		%
		disp(exception.message);
		warning('Error computing model evolution matrices');
		%
	end;%
	%
	%
end %end of the function