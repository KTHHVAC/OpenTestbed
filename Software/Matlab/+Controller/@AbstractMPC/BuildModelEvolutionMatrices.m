% Prepare model matrices over the prediction orizon for deterministic MPC.
%
% function	[													...	
% 			aafExtendedToOrizonFreeEvolutionMatrix,				...
% 			aafExtendedToOrizonForcingEvolutionMatrix,			...					
% 			aafExtendedToOrizonDisturbanceMatrix ,				...
% 			aafExtendedToOrizonOutputMatrix						...
% 			]													...
% 			= BuildModelEvolutionMatrices(						...
% 						aafStatesTransitionMatrix,				...
% 						aafInputsToStatesMatrix,				...
% 						aafDisturbancesToStatesMatrix,			...
% 						afStatesToOutputsMatrix,				...
% 						iPredictionHorizon)
% 	
%
%
function	[													...	
			aafExtendedToOrizonFreeEvolutionMatrix,				...
			aafExtendedToOrizonForcingEvolutionMatrix,			...					
			aafExtendedToOrizonDisturbanceMatrix ,				...
			aafExtendedToOrizonOutputMatrix						...
			]													...
			= BuildModelEvolutionMatrices(						...
							aafStatesTransitionMatrix,				...
							aafInputsToStatesMatrix,				...
							aafDisturbancesToStatesMatrix,			...
							afStatesToOutputsMatrix,				...
							iPredictionHorizon	)
	%
	%
	try
		% getting the size of model's matricies
		%
		iNumberOfStates		  = size(aafInputsToStatesMatrices,1);		% state size								
		iNumberOfInputs		  = size(aafInputsToStatesMatrices,2);		% number of inputs								
		iNumberOfDisturbances = size(aafDisturbancesToStatesMatrix);	% number of disturbances
		%
		%
		%
		% space allocation for matrices
		aafExtendedToOrizonFreeEvolutionMatrix      = zeros(iNumberOfStates * iPredictionHorizon,			iNumberofStates );
		aafExtendedToOrizonForcingEvolutionMatrix   = zeros(iNumberOfStates * iPredictionHorizon,			iNumberOfInputs * iPredictionHorizon);
		aafExtendedToOrizonDisturbanceMatrix        = zeros(iDisturbanceMatrixRowSize * iPredictionHorizon,	iNumberOfDisturbances * iPredictionHorizon);
		%aafExtendedToOrizonOutputMatrix            = zeros(iOutputMatrixRowSize*N,			iOutputMatrixColumnSize*N );
		%
		%------------------------------------------------------------------
		% AA costruction
		%
		for iTimeStep=1:1:iPredictionHorizon
			%
			aafExtendedToOrizonFreeEvolutionMatrix((iTimeStep-1) * iNumberOfStates+1:iTimeStep * iNumberOfStates, :)  ...
			=  aafStatesTransitionMatrix^iTimeStep;
			%
		end;%end of for
		%
		%------------------------------------------------------------------
		% CC construction
		%
		aafExtendedToOrizonOutputMatrix = kron(eye(iPredictionHorizon), afStatesToOutputsMatrix);
		%
		%------------------------------------------------------------------
		% AB construction, it manages both variant B matrix case that
		% non-variant one
		% 
		if(numel(size(aafInputsToStatesMatrix) == 2))
			%
			%
			%
			for iStepTimeRow=1:iPredictionHorizon
				%
				for iStepTimeColumn=1:iStepTimeRow
					%
					aafExtendedToOrizonForcingEvolutionMatrix														...
						(																							...
								(																					...
										(iStepTimeRow-1)															...
									*	iNumberOfStates + 1 : iStepTimeRow * iNumberOfStates						...
								),																					...
								(																					...
										(iStepTimeColumn-1)															...
									*	iNumberOfInputs + 1 : iStepTimeColumn * iNumberOfInputs	...
								)																					...
						)																							...
						=																							...
							( aafStatesTransitionMatrix^(iStepTimeRow - iStepTimeColumn) ) * aafInputsToStatesMatrix;
					%
				end;%end of innested for
				%
			end;%end of for  
			%
			%
			%
		else
			%
			for iStepTimeRow=1:iPredictionHorizon
				%
				for iStepTimeColumn=1:iStepTimeRow
					%
					aafExtendedToOrizonForcingEvolutionMatrix														...
						(																							...
								(																					...
										(iStepTimeRow-1)															...
									*	iNumberOfStates + 1 : iStepTimeRow * iNumberOfStates						...
								),																					...
								(																					...
										(iStepTimeColumn-1)															...
									*	iNumberOfInputs + 1 : iStepTimeColumn * iNumberOfInputs	...
								)																					...
						)																							...
						=																							...
							(aafStatesTransitionMatrix^(iStepTimeRow - iStepTimeColumn))							...
						*	 aafInputsToStatesMatrix(:,:,iStepTimeColumn - 1);
					%
				end;%end of innested for
				%
			end;% end of for to build aafAB  
			%
		end % end of if, choosing variant or non-variant case
		%
		%------------------------------------------------------------------
		% AE construction
		%
		for  iStepTimeRow=1:iPredictionHorizon
		   %
		   for iStepTimeColumn=1:iStepTimeRow
			   %
				aafExtendedToOrizonDisturbanceMatrix																...
					(																								...
								(iStepTimeRow-1)																	...
							*	iDisturbanceMatrixRowSize + 1 : iStepTimeRow * iDisturbanceMatrixRowSize			...
						,																							...                  			
						(																							...
								(iStepTimeColumn-1)																	...
							*	iNumberOfDisturbances + 1 : iStepTimeColumn * iNumberOfDisturbances	...
						)																							...		
					)																								...			
				= aafStatesTransitionMatrix^(iStepTimeRow-iStepTimeColumn)*aafDisturbancesToStatesMatrix;		
			end %end of innested for
			%
		end;%end of for  
		%
		%------------------------------------------------------------------
		%------------------------------------------------------------------
		%
	catch exception
		%
		disp(exception.message);
		warning('Error computing model evolution matrices');
		%
	end;%
	%
	%
end %end of the function