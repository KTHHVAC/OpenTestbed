% 'src' and 'evt' are arguments passed automatically by the 'timer' objects, 
% thus they need to be handled even if not used
%
function Run( src, evt, tCO2Controller, tTemperatureController, tPIController, tRadiatorPIController, tTCPConnection )
	%
	try %
		%
		if	(		tCO2Controller.bPrintDebugInformation			...
				||	tTemperatureController.bPrintDebugInformation	...
				||	tPIController.bPrintDebugInformation			)
			%
			fprintf('Entering Main Run()\n');
			%
		end;%
		%
		%------------------------------------------------------------------
		% computing the inputs
		tCO2Controller.AcquireMeasurements( tTCPConnection );
		tCO2Controller.AcquireForecasts( tTCPConnection );
		tCO2Controller.ComputeControlInputs();
		%
		tTemperatureController.afLowerBoundForTheVentilation = tCO2Controller.afRequestedMassFlowOverPredictionHorizon;
		%
		% temperature controller
		tTemperatureController.AcquireMeasurements( tTCPConnection );
		tTemperatureController.AcquireForecasts( tTCPConnection );
		tTemperatureController.ComputeControlInputs();
		%
		%
		%------------------------------------------------------------------
		% calling the opportune PIs (for the cooling or for the radiator)
		%
		fVentilationPercentage = tPIController.MassFlowToVentingPercentageLinearCase( tTemperatureController.fAirMassFlow ,'T');
		%
		%
		fprintf('\nThe requested Air Mass Flow is \t\t\t\t %1.6f kg/s \t corresponding to the %3.1f percent of actuation.',tTemperatureController.fAirMassFlow,fVentilationPercentage);
		fprintf('\nThe requested Mean Radiant Temperature is \t %2.2f C',tTemperatureController.fMeanRadiantTemperature);
		fprintf('\nThe requested AC Temperature is \t\t\t %2.2f C\n',tTemperatureController.fAirConditionedTemperature);
		%
		if ( tTemperatureController.fMeanRadiantTemperature > 0 )
			%
		            %Lines including the PI radiator controller
		            if strcmp(strRoom, 'A225')
		                
		                tRadiatorPIController.bUseRadiators				= true; 
		                tRadiatorPIController.fTemperatureReference		= tTemperatureController.fMeanRadiantTemperature;
		                tPIController.fRadiatorInput	= 0;
		            %
		            else
		                % % fprintf('Start Radiation PI with Tmr=%d', tTemperatureController.fMeanRadiantTemperature );
		                tPIController.fRadiatorInput												...
		                        = tTemperatureController.CalculateRadiatorValveOpeningPercentage(	...
		                                tTemperatureController.fMeanRadiantTemperature				); 
		            end
					%
					%
		else%
					%
			    tPIController.fRadiatorInput	= 0;
		            if strcmp(strRoom, 'A225')
		                tRadiatorPIController.bUseRadiators				= false; 
		            end
			%
		end;%
		%
		%
		if ( tTemperatureController.fAirConditionedTemperature > 0 )
			%
			fprintf('Start Cooling PI with Tac=%2.4f and Vent=%3.1f.', tTemperatureController.fAirConditionedTemperature, fVentilationPercentage );
			%
			tPIController.fTemperatureReference				= tTemperatureController.fAirConditionedTemperature;
			tPIController.fVentilationInput					= fVentilationPercentage;
			tPIController.bHasToWork						= true;
			tPIController.fIntegrationOfTheTemperatureError = 0;
			%
			%
		else%
			%
			tPIController.fVentilationInput		= fVentilationPercentage;
			tPIController.bHasToWork			= false;
			%
		end;%
		%
		%
		if	(		tCO2Controller.bPrintDebugInformation			...
				||	tTemperatureController.bPrintDebugInformation	...
				||	tPIController.bPrintDebugInformation			)
			%
			fprintf('Exiting Main Run()\n\n');
			%
		end;%
		%
		%
	catch exception
		%
		disp( exception.message );
		warning('Unable to run the main control cycle');
		%
	end;% end catch
	%
end %

