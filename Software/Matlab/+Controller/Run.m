% 'src' and 'evt' are arguments passed automatically by the 'timer' objects, 
% thus they need to be handled even if not used
%
function Run( src, evt, tCO2Controller, tTemperatureController, tPIController, tTCPConnection )
	%
	try %
		%
		if	(		tCO2Controller.bPrintDebugInformation			...
				||	tTemperatureController.bPrintDebugInformation	...
				||	tPIController.bPrintDebugInformation			)
			%
			fprintf('Entering Main Run()\n');
			%
		end;%
		%
		%------------------------------------------------------------------
		% computing the inputs
		tCO2Controller.AcquireMeasurements( tTCPConnection );
		tCO2Controller.AcquireForecasts( tTCPConnection );
		tCO2Controller.ComputeControlInputs();
		%
		tTemperatureController.afLowerBoundForTheVentilation = tCO2Controller.afRequestedMassFlowOverPredictionHorizon;
		%
		% temperature controller
		tTemperatureController.AcquireMeasurements( tTCPConnection );
		tTemperatureController.AcquireForecasts( tTCPConnection );
		tTemperatureController.ComputeControlInputs();
		%
		%
		%------------------------------------------------------------------
		% calling the opportune PIs (for the cooling or for the radiator)
		%
		fVentilationPercentage = tPIController.MassFlowToVentingPercentageLinearCase( tTemperatureController.fAirMassFlow ,'T');
		%
		%
		fprintf('\nThe requested Air Mass Flow is \t\t\t\t %d kg/s \t corresponding to the %d percent of actuation.',tTemperatureController.fAirMassFlow,fVentilationPercentage);
		fprintf('\nThe requested Mean Radiant Temperature is \t %d C',tTemperatureController.fMeanRadiantTemperature);
		fprintf('\nThe requested AC Temperature is \t\t\t %d C\n',tTemperatureController.fAirConditionedTemperature);
		%
		if ( tTemperatureController.fMeanRadiantTemperature > 0 )
			%
			fprintf('Start Radiation PI with Tmr=%d', tTemperatureController.fMeanRadiantTemperature );
			tPIController.fRadiatorInput	= 10; % TODO: write a function to calculate the 
			%
			%
		else%
			%
			tPIController.fRadiatorInput	= 0;
			%
		end;%
		%
		%
		if ( tTemperatureController.fAirConditionedTemperature > 0 )
			%
			fprintf('Start Cooling PI with Tac=%d and Vent=%d.', tTemperatureController.fAirConditionedTemperature, fVentilationPercentage );
			%
			tPIController.fTemperatureReference = tTemperatureController.fAirConditionedTemperature;
			tPIController.fVentilationInput		= fVentilationPercentage;
			tPIController.bHasToWork			= true;
			%
			%
		else%
			%
			tPIController.fVentilationInput		= fVentilationPercentage;
			tPIController.bHasToWork			= false;
			%
		end;%
		%
		%
		if	(		tCO2Controller.bPrintDebugInformation			...
				||	tTemperatureController.bPrintDebugInformation	...
				||	tPIController.bPrintDebugInformation			)
			%
			fprintf('Exiting Main Run()\n\n');
			%
		end;%
		%
		%
	catch exception
		%
		disp( exception.message );
		warning('Unable to run the main control cycle');
		%
	end;% end catch
	%
end %

