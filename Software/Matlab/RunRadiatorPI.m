% locked out from the system
if( any( strcmp( who, 'tTCPConnection' ) ) )
	
	fclose( tTCPConnection.tTcpIpClient );
	
end;

close all;
clear all;
clear classes;
clc;

% to get the updated models
addpath(genpath('Models/'));

% to get CPLEX path
addpath(genpath('C:/Program Files/IBM/ILOG/CPLEX_Studio125/cplex'));

% import the necessary classes
import EstimationAlgorithms.*;
import Controller.*;
import MatlabToTikZ.*;
import InternetConnection.*;
import Scenarios.*;

% allocate the TCP connection object
global tTCPConnection;
tTCPConnectionParameters				= InternetConnection.LoadDefaultTCPConnectionParameters();
tTCPConnection							= InternetConnection.KTHConnection( tTCPConnectionParameters );

% allocate the controller
global tRadiatorPIController;
tRadiatorPIControllerParameters			= Controller.LoadPIControllerParameters();
tRadiatorPIController					= Controller.PIController( tRadiatorPIControllerParameters );
tRadiatorPIController.bUseRadiators		= true;


%% timer
tControllerDebugTimer = timer(																						...
		'TimerFcn',			{@Controller.RunRadiatorPIController,			 tRadiatorPIController, tTCPConnection},...
		'ErrorFcn',			{@Controller.OnError,							{tRadiatorPIController} },				...
		'StartFcn',			{@Controller.OnStart,							{tRadiatorPIController} },				...
		'StopFcn',			{@Controller.OnExitNoTCPClose,					{tRadiatorPIController} },				...
		'Period',			tRadiatorPIController.fSamplingTimeInSeconds,											...
		'TasksToExecute',	tRadiatorPIController.iNumberOfRunsToBeExecuted,										...
		'ExecutionMode',	'fixedRate',																			...
		'BusyMode',			'drop'																					);

start( tControllerDebugTimer );


%% At the end of the experience

% Set the radiator valve opening again to zero
% tTCPConnection.SendToServer( 63, 2002, 'LB201_A225', 0 );
%
% always delete timers before exiting!
% delete(tControllerDebugTimer);
%
% Experiment is done -> We close the connection
% fclose( tTCPConnection.tTcpIpClient );




