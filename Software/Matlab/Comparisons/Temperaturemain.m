clc
clear all
close all

% to get the updated models
addpath(genpath('Models/'));
addpath(genpath('C:\Users\Luca\Documents\GitHub\OpenTestbed\Software\Matlab\Comparisons'));
addpath(genpath('C:/Program Files/IBM/ILOG/CPLEX_Studio125/cplex'));

load('SavedData/Disturbances.mat')
load('SavedData/TemperatureScenario.mat')


tTemperatureControllerParameters								= Controller.LoadStochasticTemperatureMPCParameters();
tImplicitTemperatureController									= Controller.StochasticTemperatureComparisonMPC( tTemperatureControllerParameters );
tTemperatureControllerParameters								= Controller.LoadExplicitTemperatureMPCParameters();
tExplicitTemperatureController									= Controller.ExplicitWCTemperatureMPC( tTemperatureControllerParameters );

tImplicitTemperatureController.afLowerBoundForTheVentilation			= repmat(0.14, 1, tImplicitTemperatureController.iPredictionHorizon);
tImplicitTemperatureController.fSamplingTimeInSeconds					= 30*60;	
tImplicitTemperatureController.iPredictionHorizon						= 24;		
tImplicitTemperatureController.iNumberOfScenarios						= 1000 ;
fInitialCondition														= 19.8;

BuildingMatrixUnix;




%% Implicit Simulation Temperature

tImplicitTemperatureController.tModel.afCurrentState					= fInitialCondition*ones(13,1);
tImplicitTemperatureController.tModel.aafDisturbancesScenarioMatrix		= aafDisturbancesScenarioMatrix;



aafStatesMatrixImplicit													...	
	= zeros(	13,														...
				tImplicitTemperatureController.iPredictionHorizon + 1);
afInputsMatrixImplicit													...
	= zeros(	5,														...
				tImplicitTemperatureController.iPredictionHorizon);
tImplicitTemperatureController.tSimulation.aafStatesMatrixImplicit(:,1)											... 
	= tImplicitTemperatureController.tModel.afCurrentState;

for iTimeStep = 1:tImplicitTemperatureController.iPredictionHorizon
	%
	tImplicitTemperatureController.ComputeControlInputs();
	%
	afInputsMatrixImplicit(:,iTimeStep)													...
		= [		tImplicitTemperatureController.afOptimizationProblemSolution(1);		...
				tImplicitTemperatureController.afOptimizationProblemSolution(2);		...
				tImplicitTemperatureController.afOptimizationProblemSolution(3);		...
				tImplicitTemperatureController.afOptimizationProblemSolution(4);		...
				tImplicitTemperatureController.afOptimizationProblemSolution(5); 		...
			];
	%
	Simulation
	%
	tImplicitTemperatureController.tModel.afCurrentState						...
		= tImplicitTemperatureController.tSimulation.aafStatesMatrixImplicit(:,iTimeStep );
end;%



% Explicit Simulation
x0								=	fInitialCondition*ones(2,1);
afWallsArea                     =	[30.08,28.8,30.08,28.8,84.6,84.6];

tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit													...	
	= zeros(	13,																					...
				tExplicitTemperatureController.iPredictionHorizon + 1);
tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit													...
	= zeros(	5,																					...
				tExplicitTemperatureController.iPredictionHorizon);
tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit(:,1)												... 
	= fInitialCondition*ones(13,1);

cd Comparisons\Temperature\

[Inputs, iRegion]				=	OriginalPWAfunction(x0);
cd ..\..
tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit(:,1)		=	Inputs;
fTotalArea						=	sum(afWallsArea);

for k =  1:tExplicitTemperatureController.iPredictionHorizon
	%
	%
	tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit(:,k+1)		=		A	* tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit(:,k)		...
																						+	E	* W(:,k)							...
																						+	B	* tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit(:,k) ;
	%
	fAverageWallsTemperature			=		1/fTotalArea						...
											*	afWallsArea							...
											* [	tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit(3,k+1);		...
												tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit(5,k+1);		...
												tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit(7,k+1);		...
												tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit(9,k+1);		...
												tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit(11,k+1);	...
												tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit(13,k+1)];
	%
	afTwoStatesVector					=	[	tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit(1,k+1);		...
												fAverageWallsTemperature];
	%
	cd Comparisons\Temperature\
	[afInputs, iRegion]				=	OriginalPWAfunction(afTwoStatesVector);
	cd ..\..
	%
	tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit(:,k+1)	=	afInputs;
	%
end;%
tExplicitTemperatureController.Postprocessing();

N = tExplicitTemperatureController.iPredictionHorizon;


afInputsMatrixImplicit	= afInputsMatrixImplicit(:,1:N);
tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit	= tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit(:,1:N);

afOutputVectorImplicit		= C	* tImplicitTemperatureController.tSimulation.aafStatesMatrixImplicit;
tExplicitTemperatureController.tSimulation.afOutputVectorExplicit		= C	* tExplicitTemperatureController.tSimulation.aafStatesMatrixExplicit;

fDeltaThImplicit		= afInputsMatrixImplicit(1,:)';
fDeltaTcImplicit		= afInputsMatrixImplicit(2,:)';
fDeltaUhImplicit		= afInputsMatrixImplicit(3,:)';
fDeltaUcImplicit		= afInputsMatrixImplicit(4,:)';
fDeltaRadImplicit		= afInputsMatrixImplicit(5,:)';

fDeltaThExplicit		= tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit(1,:)';
fDeltaTcExplicit		= tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit(2,:)';
fDeltaUhExplicit		= tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit(3,:)';
fDeltaUcExplicit		= tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit(4,:)';
fDeltaRadExplicit		= tExplicitTemperatureController.tSimulation.afInputsMatrixExplicit(5,:)';

% EnergyComputation


figure(1)

hold on
plot(0:1:N,afOutputVectorImplicit,'--rs','LineWidth',2,...
                       'MarkerEdgeColor','k',...
                       'MarkerFaceColor','r',...
                       'MarkerSize',10)
plot(0:1:N,tExplicitTemperatureController.tSimulation.afOutputVectorExplicit,'--bs','LineWidth',2,...
                       'MarkerEdgeColor','k',...
                       'MarkerFaceColor','b',...
                       'MarkerSize',10)		   
plot(0:1:N,20*ones(1,N+1),'--g','LineWidth',2)
plot(0:1:N,22*ones(1,N+1),'--g','LineWidth',2)
hold off
legend('Implicit','Explicit')
title('output')

figure(2)
subplot(3,2,1)
hold on
stairs(0:N-1,fDeltaRadImplicit,'r');
stairs(0:N-1,fDeltaRadExplicit,'b');
hold off
title('DeltaTrad')
subplot(3,2,2)
hold on
stairs(0:N-1,fDeltaThImplicit,'r');
stairs(0:N-1,fDeltaThExplicit,'b');
hold off
title('DeltaTh')
subplot(3,2,3)
hold on
stairs(0:N-1,fDeltaUhImplicit,'r');
stairs(0:N-1,fDeltaUhExplicit,'b');
hold off
title('u_h')
subplot(3,2,4)
hold on
stairs(0:N-1,fDeltaTcImplicit,'r');
stairs(0:N-1,fDeltaTcExplicit,'b');
hold off
title('DeltaTc')
subplot(3,2,5)
hold on
stairs(0:N-1,fDeltaUcImplicit,'r');
stairs(0:N-1,fDeltaUcExplicit,'b');
hold on
title('u_c')
legend('Implicit','Explicit')

