clc
clear all
close all

% to get the updated models
addpath(genpath('Models/'));
addpath(genpath('C:\Users\Luca\Documents\GitHub\OpenTestbed\Software\Matlab\Comparisons'));

load('SavedData/Disturbances.mat')
load('SavedData/Scenarios.mat')

cd ../..

tTemperatureControllerParameters								= Controller.LoadStochasticTemperatureMPCParameters();
tTemperatureController											= Controller.StochasticTemperatureComparisonMPC( tTemperatureControllerParameters );
tTemperatureController.afLowerBoundForTheVentilation			= repmat(0.14, 1, tTemperatureController.iPredictionHorizon);
[	tTemperatureController.tSimulationModel.aafA,				...
	tTemperatureController.tSimulationModel.aafB,				...
	tTemperatureController.tSimulationModel.aafC,				...
	tTemperatureController.tSimulationModel.aafE]				= BuildingMatrixUnix;

tExpController													= [];


tTemperatureController.fSamplingTimeInSeconds					= 30*60;	
tTemperatureController.iPredictionHorizon						= 24;		
tTemperatureController.iNumberOfScenarios						= 1000 ;
fInitialCondition												= 23.3;

%% Implicit Simulation Temperature

tTemperatureController.tModel.afCurrentState					= fInitialCondition*ones(13,1);
tTemperatureController.tModel.aafDisturbancesScenarioMatrix		= aafDisturbancesScenarioMatrix;



aafStatesMatrixImplicit													...	
	= zeros(	13,														...
				tTemperatureController.iPredictionHorizon + 1);
afInputsMatrixImplicit													...
	= zeros(	5,														...
				tTemperatureController.iPredictionHorizon);
aafStatesMatrixImplicit(:,1)											... 
	= tTemperatureController.tModel.afCurrentState;

for iTimeStep = 1:tTemperatureController.iPredictionHorizon
	%
	tTemperatureController.ComputeControlInputs();
	%
	afInputsMatrixImplicit(:,iTimeStep)									...
		= tTemperatureController.tModel.afInputsSolution;
	%
	Simulation
	%
	tTemperatureController.tModel.afCurrentState						...
		= tTemperatureController.tSimulation.aafStatesMatrixImplicit(:,iTimeStep );
end;%



% Explicit Simulation
x0							= fInitialCondition*ones(2,1);
afSignificantStatesVector	= 12	:	0.5	:	27;
afWallsArea                     =	[30.08,28.8,30.08,28.8,84.6,84.6];

tExpController.tSimulation.aafStatesMatrixExplicit													...	
	= zeros(	13,														...
				tTemperatureController.iPredictionHorizon + 1);
tExpController.tSimulation.afInputsMatrixExplicit													...
	= zeros(	5,														...
				tTemperatureController.iPredictionHorizon);
tExpController.tSimulation.aafStatesMatrixExplicit(:,1)											... 
	= fInitialCondition*ones(13,1);


[Inputs, iRegion]				=	OriginalPWAfunction(x0);
tExpController.tSimulation.afInputsMatrixExplicit(:,1)		=	Inputs;
fTotalArea						=	sum(afWallsArea);

for k =  1:tTemperatureController.iPredictionHorizon
	%
	%
	tExpController.tSimulation.aafStatesMatrixExplicit(:,k+1)		=		A	* tExpController.tSimulation.aafStatesMatrixExplicit(:,k)		...
																		+	E	* W(:,k)							...
											+	B	* tExpController.tSimulation.afInputsMatrixExplicit(:,k) ;
	%
	fAverageWallsTemperature			=		1/fTotalArea						...
											*	afWallsArea							...
											* [	tExpController.tSimulation.aafStatesMatrixExplicit(3,k+1);		...
												tExpController.tSimulation.aafStatesMatrixExplicit(5,k+1);		...
												tExpController.tSimulation.aafStatesMatrixExplicit(7,k+1);		...
												tExpController.tSimulation.aafStatesMatrixExplicit(9,k+1);		...
												tExpController.tSimulation.aafStatesMatrixExplicit(11,k+1);	...
												tExpController.tSimulation.aafStatesMatrixExplicit(13,k+1)];
	%
	afTwoStatesVector					=	[	tExpController.tSimulation.tController.tSimulation.aafStatesMatrixExplicit(1,k+1);		...
												fAverageWallsTemperature];
	%
	[afInputs, iRegion]				=	OriginalPWAfunction(afTwoStatesVector);
	%
	tExpController.tSimulation.afInputsMatrixExplicit(:,k+1)	=	afInputs;
	%
end;%

N = tTemperatureController.iPredictionHorizon;


afInputsMatrixImplicit	= afInputsMatrixImplicit(:,1:N);
tExpController.tSimulation.afInputsMatrixExplicit	= tExpController.tSimulation.afInputsMatrixExplicit(:,1:N);

afOutputVectorImplicit		= C	* aafStatesMatrixImplicit;
tExpController.tSimulation.afOutputVectorExplicit		= C	* tExpController.tSimulation.aafStatesMatrixExplicit;

fDeltaThImplicit		= afInputsMatrixImplicit(1,:)';
fDeltaTcImplicit		= afInputsMatrixImplicit(2,:)';
fDeltaUhImplicit		= afInputsMatrixImplicit(3,:)';
fDeltaUcImplicit		= afInputsMatrixImplicit(4,:)';
fDeltaRadImplicit		= afInputsMatrixImplicit(5,:)';

fDeltaThExplicit		= tExpController.tSimulation.afInputsMatrixExplicit(1,:)';
fDeltaTcExplicit		= tExpController.tSimulation.afInputsMatrixExplicit(2,:)';
fDeltaUhExplicit		= tExpController.tSimulation.afInputsMatrixExplicit(3,:)';
fDeltaUcExplicit		= tExpController.tSimulation.afInputsMatrixExplicit(4,:)';
fDeltaRadExplicit		= tExpController.tSimulation.afInputsMatrixExplicit(5,:)';

EnergyComputation


figure(1)

hold on
plot(0:1:N,afOutputVectorImplicit,'--rs','LineWidth',2,...
                       'MarkerEdgeColor','k',...
                       'MarkerFaceColor','r',...
                       'MarkerSize',10)
plot(0:1:N,tExpController.tSimulation.afOutputVectorExplicit,'--bs','LineWidth',2,...
                       'MarkerEdgeColor','k',...
                       'MarkerFaceColor','b',...
                       'MarkerSize',10)		   
plot(0:1:N,20*ones(1,N+1),'--g','LineWidth',2)
plot(0:1:N,22*ones(1,N+1),'--g','LineWidth',2)
hold off
legend('Implicit','Explicit')
title('output')

figure(2)
subplot(3,2,1)
hold on
stairs(0:N-1,fDeltaRadImplicit,'r');
stairs(0:N-1,fDeltaRadExplicit,'b');
hold off
title('DeltaTrad')
subplot(3,2,2)
hold on
stairs(0:N-1,fDeltaThImplicit,'r');
stairs(0:N-1,fDeltaThExplicit,'b');
hold off
title('DeltaTh')
subplot(3,2,3)
hold on
stairs(0:N-1,fDeltaUhImplicit,'r');
stairs(0:N-1,fDeltaUhExplicit,'b');
hold off
title('u_h')
subplot(3,2,4)
hold on
stairs(0:N-1,fDeltaTcImplicit,'r');
stairs(0:N-1,fDeltaTcExplicit,'b');
hold off
title('DeltaTc')
subplot(3,2,5)
hold on
stairs(0:N-1,fDeltaUcImplicit,'r');
stairs(0:N-1,fDeltaUcExplicit,'b');
hold on
title('u_c')
legend('Implicit','Explicit')

