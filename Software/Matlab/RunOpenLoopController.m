% clean the workspace -- but close the TCP connection properly! Or you get
% locked out from the system
if( any( strcmp( who, 'tTCPConnection' ) ) )
	%
	fclose( tTCPConnection.tTcpIpClient );
	%
end;%


close all;
clear all;
clear classes;
clc;


% import the necessary classes
import EstimationAlgorithms.*;
import Controller.*;
import MatlabToTikZ.*;
import InternetConnection.*;
import Scenarios.*;



% load the parameters
tControllerParameters 		= Controller.LoadOpenLoopControllerParameters(); %openloop!
tTCPConnectionParameters 	= InternetConnection.LoadDefaultTCPConnectionParameters();

% allocate the TCP connection and the controller
tTCPConnection 	= InternetConnection.KTHConnection( tTCPConnectionParameters );
tController 	= Controller.OpenLoopController(	tControllerParameters,	...
												   	'./+Controller/@OpenLoopController/Test_radiator_01.txt'	);


% start the control cycle
tControlTimer 	= timer(	'TimerFcn',			{@Controller.RunOpenLoop,		  tController, tTCPConnection},		...
							'ErrorFcn',			{@Controller.OnError,			{ tController } },					...
							'StartFcn',			{@Controller.OnStart,			{ tController } },					...
							'StopFcn',			{@Controller.OnExitNoTCPClose,	{ tController } },					...
							'Period',			tController.fSamplingTimeInSeconds,									...
							'TasksToExecute',	tController.iNumberOfRunsToBeExecuted,								...
							'ExecutionMode',	'fixedRate',														...
							'BusyMode',			'drop'																);
start( tControlTimer );


% % wait up to the moment that the experiment is concluded
% while( tControlTimer.TasksExecuted < tControlTimer.TasksToExecute )
% 	%
% 	pause( 60 )
% 	%
% end;%


% % always delete timers before exiting!
% delete(tControlTimer);
% fprintf('\n\nExperiment concluded succesfully\n');


